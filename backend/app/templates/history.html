{% extends "base_sidebar.html" %}
{% block title %}{{ _('Moja Historia Przetwarzania') }} - WaveBulk{% endblock %}
{% block main_content_class %} full-width{% endblock %}
{% block content %}
<div class="container-full">
        <section class="section-title">
            <h2>{{ _('Moja Historia Przetwarzania') }}</h2>
            <p>{{ _('Lista wszystkich Twoich przetworzonych plików audio.') }}</p>
        </section>
        
        <!-- Filters and Search -->
        <div class="history-controls mb-4">
            <div class="search-box">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                </svg>
                <input type="text" id="search-input" placeholder="{{ _('Szukaj po nazwie pliku...') }}" class="search-input">
            </div>
            
            <div class="filter-buttons">
                <button class="filter-btn active" data-filter="all">{{ _('Wszystkie') }}</button>
                <button class="filter-btn" data-filter="completed">{{ _('Ukończone') }}</button>
                <button class="filter-btn" data-filter="processing">{{ _('W trakcie') }}</button>
                <button class="filter-btn" data-filter="failed">{{ _('Błędy') }}</button>
            </div>
        </div>
        {% if history_data %}
        <div id="history-container">
            <div class="table-responsive">
                <table class="table table-dark table-striped" id="history-table">
                    <thead>
                        <tr>
                            <th style="width: 3%;"><input type="checkbox" id="select-all-checkbox" class="form-check-input"></th>
                            <th>{{ _('Nazwa pliku') }}</th>
                            <th>{{ _('Rozmiar') }}</th>
                            <th>{{ _('Status') }}</th>
                            <th>{{ _('Głośność LUFS') }}</th>
                            <th>True Peak (dBTP)</th>
                            <th>{{ _('Czas trwania') }}</th>
                            <th>{{ _('Data') }}</th>
                            <th>{{ _('Akcje') }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in history_data %}
                        <tr id="task-row-{{ item.task_id }}" class="file-row" data-status="{{ item.current_status }}" {% if item.current_status in ['QUEUED', 'PROCESSING', 'PENDING'] and item.task_status_url %}data-status-url="{{ item.task_status_url }}"{% endif %}>
                            <td><input type="checkbox" class="form-check-input file-checkbox" value="{{ item.audio_file_id }}"></td>
                            <td>
                                <a href="{{ url_for('audio_processing.file_details', file_id=item.audio_file_id) }}" class="file-link">
                                    {{ item.original_filename }}
                                </a>
                            </td>
                            <td>{{ (item.file_size_bytes / 1024 / 1024)|round(2) if item.file_size_bytes else 'N/A' }} MB</td>
                            <td id="task-status-cell-{{ item.task_id }}">
                                {% if item.current_status == 'COMPLETED' %}<span class="badge bg-success">{{ _('Ukończono') }}</span>
                                {% elif item.current_status in ['PENDING', 'QUEUED', 'PROCESSING'] %}<span class="badge bg-warning text-dark">{{ _('W trakcie...') }}</span>
                                {% elif item.current_status == 'FAILED' %}<span class="badge bg-danger">{{ _('Błąd') }}</span>
                                {% else %}<span class="badge bg-secondary">{{ _('Brak statusu') }}</span>{% endif %}
                            </td>
                            <td>
                                {% if item.loudness_lufs is not none %}
                                    <span class="lufs-value {% if item.loudness_lufs < -16 %}lufs-quiet{% elif item.loudness_lufs > -10 %}lufs-loud{% endif %}">
                                        {{ "%.1f"|format(item.loudness_lufs) }}
                                    </span>
                                {% else %}N/A{% endif %}
                            </td>
                            <td>{{ "%.1f dB"|format(item.true_peak_db) if item.true_peak_db is not none else 'N/A' }}</td>
                            <td>{{ "%.1f s"|format(item.duration_seconds) if item.duration_seconds is not none else 'N/A' }}</td>
                            <td>{{ item.upload_date.split('T')[0] }}</td>
                            <td id="task-actions-cell-{{ item.task_id }}" class="actions-cell">
                                <a href="{{ url_for('audio_processing.file_details', file_id=item.audio_file_id) }}" class="btn btn-secondary btn-sm">{{ _('Szczegóły') }}</a>
                                {% if item.processed_file_url %}
                                    <a href="{{ item.processed_file_url }}" class="btn btn-primary btn-sm" download>{{ _('Pobierz') }}</a>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="d-flex justify-end gap-2 mt-3">
                <button id="download-selected-btn" class="btn btn-success" disabled>{{ _('Pobierz zaznaczone (ZIP)') }}</button>
                <button id="delete-selected-btn" class="btn btn-danger" disabled>{{ _('Usuń zaznaczone') }}</button>
            </div>
        </div>
        {% else %}
        <p class="text-center text-secondary mt-4">{{ _('Nie masz jeszcze żadnych przetworzonych plików.') }}</p>
        {% endif %}
    </main>
</div>
{% endblock %}
{% block scripts %}{{ super() }}<script src="{{ url_for('static', filename='js/history.js') }}" defer></script>{% endblock %}
